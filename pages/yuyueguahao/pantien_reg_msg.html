<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
        <meta name="format-detection" content="telephone=no">
        <link rel="stylesheet" href="../../css/frozen.css">
        <link rel="stylesheet" href="../../css/style.css">
        <link rel="stylesheet" href="../../fontIcon/iconfont.css" />
        
        <script src="../../js/jquery-1.8.3.min.js"></script>
        <script>$.noConflict();</script>
        <script src="../../lib/zepto.min.js"></script>
        <script src="../../js/frozen.js"></script>
        <script src="../../js/Utils.js"></script>
		<title></title>
		<style type="text/css">
			html,body{background-color: #ffffff;}
			.name_container{display: block;float: left;width: 100%;}
            .nam_c{display: block;float: left; width:94%;margin-left: 3%; height: 50px;border-bottom: 1px solid #EEEAEB;}
            .nam_left{display: block;float: left; width: 40%; height:50px;line-height:50px;}
            .nam_c>input{display: block;width: 55%;height:50px;line-height:50px;float: left;text-align: right;border: none;background:none;}
			
			.login_btn{display: block;float: left; width: 94%;margin-left: 3%;margin-top: 25px;}
			.login_btn>button{border-radius:2px ;background: #0066CC;font-size: 16px;}
			
			.dialog_groupMsg{display: none;position: fixed;top: 0;left: 0;width: 100%;height: 100%;z-index: 9999;background: rgba(0,0,0,0.4);}
			.dialog_sendMsg_cnt{display: block;width: 80%;min-height: 100px;max-height: 800px;background-color: #FFFFFF;position: relative;margin-left: 10%;margin-top: 20%;border-radius: 5px;}
			.ui-dialog-ft .close_groupMsg{color: red;}
			input{padding-left: 5px;}
			
			.group_textArea{width: 94%;height: 70px;padding: 3% 3%;font-size: 14px;resize:none;border: 1px solid #5EB6CB;}
			.radio_con{display: block;width: 100%;margin-top: -18px;}
			.radio_item{display: block;float: left;width: 100%;height: 40px;line-height: 40px;border-bottom: 1px solid #EEEAEB;color: #999999;}
			.radio_item.active{color: #5EB6CB;}
			.radio_item>i{display: block;float: left;width: 12%;}
			.radio_item>span{display: block;float: right;width: 88%;font-size: 15px;}
			
		</style>
		<script type="text/javascript">
        	$(function(){
        		var Request = new Object();
        		Request = Utils.getRequest();
        		
        		$("#bespeakId").val(Request["bespeakId"]);
        		$("#hisOrdNum").val(Request["hisOrdNum"]);
        		$("#serialNumber").val(Request["serialNumber"]);
				var params={};
				params.bespeakId=Request["bespeakId"];
        		$.post(Utils.getRoot()+"/registerApp/selPatientYYInfo",params,function(data){
					if (data.success) {
						var Patient = data.data;
						var patientGender = Patient.patientGender=="1"?"男":"女";
						$("#hisPatientId").val(Patient.hisPatientId);
						$("#patientname").val(Patient.patientName);
						$("#sex").val(patientGender);
						$("#idcard").val(Patient.patientIdcard);
						$("#phone").val(Patient.patientPhoneNumber);
						$("#attendancecard").val(Patient.patientCardNumber);
						$("#divisionName").val(Patient.divisionName);
						$("#doctorName").val(Patient.doctorName);
						$("#money").val(Patient.money/100);
						$("#bespeakTime").val(Patient.bespeakTime);
						var status = Patient.yyStatus;
						var yyStatus;
						switch (status){
							case "0":
								yyStatus="预约";
								$("#cancel").show();//显示按钮
								break;
							case "1":
								yyStatus="取消";
								break;
							case "2":
								yyStatus="取号";
								$("#cancel").show();//显示按钮
								break;
							case "3":
								yyStatus="退约";
								break;
						}
						$("#status").val(status);
						$("#yyStatus").val(yyStatus);
					}
				});
				
				$(".dialog_groupMsg").hide();
				
				$("#cancel").click(function(){
					$(".dialog_groupMsg").show();
				});
				
				$(".close_groupMsg").click(function(){
					$(".dialog_groupMsg").hide();
				});
				
				$("#queren").click(function(){
					var active = $(".radio_con").children(".active");
					if($(active).attr("id")=="qtsm"){
						if ($("#cancelReason").val().length>5) {
							$(".dialog_groupMsg").hide();
							cancel($("#cancelReason").text());
						}else{
							alert("其他原因说明至少5个字以上");
						}
					}else{
						cancel($(active).children("span").text());
					}
//					
				});
				
				
				//取消预约
				function cancel(cancelReason) {
					//医院取消预约
					var params={};
					params.bespeakId = $("#bespeakId").val();
					params.hisOrdNum = $("#hisOrdNum").val();
					params.serialNumber = $("#serialNumber").val();
					params.cancelReason = cancelReason;
					//取消未支付的预约信息，先取消预约，取消锁号
					if($("#status").val()==0){
						$.post(Utils.getRoot()+"/registerApp/cancelBespeakInfoNo",params,function(data){
							if (data.success) {
//								$(".login_btn").hide();
								alert(data.message);
								$("#yyStatus").val("已取消");//改变状态
								$("#cancel").hide();//隐藏按钮
							}else{
								alert(data.message);
							}
						});
					}else if($("#status").val()==2){
						//取消已支付的预约信息，先取消预约，取消锁号
						$.post(Utils.getRoot()+"/registerApp/cancelBespeakInfo",params,function(data){
							if (data.success) {
								//最后再退款
								/*outChargeNo 支付订单号 String(32) N
								outRefundNo 退款流水号 String(32) N
								refundAmt 退款金额，单位为分 Number(12) N*/
								$.post(Utils.getRoot()+"/registerApp/refund", {
									outChargeNo: $("#hisOrdNum").val(),
									outRefundNo: $("#serialNumber").val(),
									refundAmt: $("#money").val(),
									czDate:Request["czDate"],//预约日期
									createTime:createTime//创建日期
								}, function(res) {
									if (res.success) {//退款成功
//										$(".login_btn").hide();
										alert(res.message);
										$("#yyStatus").val("退约");//改变状态
										$("#cancel").hide();//隐藏按钮
									}else{//退款失败
										alert(res.message);
										$("#yyStatus").val("退约");//改变状态
										$("#cancel").hide();//隐藏按钮
										$("#refund").show();
									}
								});
							} else {
								alert(data.message);
							}
						});
					}
					
				}
				
				$("#refund").click(function(){
					$.post(Utils.getRoot()+"/registerApp/refund", {
						outChargeNo: $("#hisOrdNum").val(),
						outRefundNo: $("#serialNumber").val(),
						refundAmt: $("#money").val()
					}, function(res) {
						if (res.success) {
//							$(".login_btn").hide();
							alert(res.message);
							$("#yyStatus").val("退约");//改变状态
							$("#cancel").hide();//隐藏按钮
						}else{
							alert(res.message);
							$("#yyStatus").val("退约");//改变状态
							$("#cancel").hide();//隐藏按钮
							$("#refund").show();
						}
					});
				});
				
				$(".radio_con").on("click",".radio_item",function(){
					var a = $(this).hasClass("active");
					if(!a){
						$(this).addClass("active").siblings(".radio_item").removeClass("active");
						$(this).children("i").addClass("icon-zhengquewancheng").parent(".radio_item").siblings(".radio_item").children("i").removeClass("icon-zhengquewancheng");
						if ($(this).attr("id")=="qtsm") {
							$(".edit_sendMsg").show();
						}else{
							$("#cancelReason").html("");
							$(".edit_sendMsg").hide();
						}
					}
					
				});
				
			});
		</script>
	</head>
	<body>
		<header class="ui-header ui-header-positive">
	        <i class="ui-icon ui-icon-return" onclick="history.back()"></i>
	        <h4 style="margin-left: 25px;">预约挂号详情 </h4>
		</header>
		<section class="ui-container">
			<input type="hidden" id="hisPatientId" value="">
			<div class="name_container">
				<div class="nam_c">
		    		<span class="nam_left" >姓名：</span>
		    		<input type="text"  disabled="disabled"  id="patientname"  value="" />
		        </div>
		        <div class="nam_c">
		    		<span class="nam_left">性别：</span>
		    		<input type="text" disabled="disabled" id="sex" value=""  />
		        </div>
		        
		        <div class="nam_c">
		    		<span class="nam_left">身份证号码：</span>
		    		<input type="text" disabled="disabled" id="idcard" value="" />
		        </div>
		        
		        <div class="nam_c">
		    		<span class="nam_left">手机号码：</span>
		    		<input type="text" disabled="disabled" id="phone"value="" />
		        </div>
		        <div class="nam_c">
		    		<span class="nam_left">就诊卡号：</span>
		    		<input type="text" disabled="disabled" id="attendancecard" value="" />
		        </div>
		        
		        <div class="nam_c">
		    		<span class="nam_left">科室：</span>
		    		<input type="text" disabled="disabled" id="divisionName" value="" />
		        </div>
		        
		        <div class="nam_c">
		    		<span class="nam_left">医生：</span>
		    		<input type="text" disabled="disabled" id="doctorName" value="" />
		        </div>
		        
		        <div class="nam_c">
		    		<span class="nam_left">金额(单位/元)：</span>
					<input type="text" disabled="disabled" id="money" value="" />
		        </div>
		
		        <div class="nam_c">
		    		<span class="nam_left">就诊时间：</span>
					<input type="text" disabled="disabled" id="bespeakTime" value="" />
		        </div>
		        
		        <b>
			        <div class="nam_c" style="color: red;">
		        		<span class="nam_left">状态：</span>
						<input type="text" disabled="disabled" id="yyStatus" value="" />
						<input type="hidden" disabled="disabled" id="status" value="" />
			        </div>
				</b>
			</div>
	        
			<div class="login_btn">
				<input type="hidden"  id="bespeakId" value=""/>
				<input type="hidden"  id="hisOrdNum" value=""/>
		       	<input type="hidden"  id="serialNumber" value=""/>
				<button id="cancel" class="ui-btn ui-btn-lg ui-btn-primary" >取消预约</button>
				<button id="refund" class="ui-btn ui-btn-lg ui-btn-primary" style="display: none;">退款</button>
			</div>
			
			<!-- 取消预约窗口-->
			<div class="dialog_groupMsg">
				<div class="dialog_sendMsg_cnt">
					<div class="ui-dialog-hd ui-border-b">
						<h4>取消预约原因</h4> 
					</div>
					
					<div class="ui-dialog-bd">
						<div class="radio_con">
							<div class="radio_item active">
		                     	<i class="iconfont icon-zhengquewancheng"></i> 
		                     	<span>科室预约错误</span>
		                    </div>
							<div class="radio_item">
		                     	<i class="iconfont "></i> 
		                     	<span>医生预约错误</span>
		                    </div>
							<div class="radio_item">
		                     	<i class="iconfont "></i> 
		                     	<span>预约时间错误</span>
		                    </div>
							<div class="radio_item" id="qtsm">
		                     	<i class="iconfont "></i> 
		                     	<span>其他原因说明</span>
		                    </div>
						</div>
						<!-- 编辑取消预约原因 -->
						<div class="edit_sendMsg" style="display: none;">
							<textarea class="group_textArea" id="cancelReason" placeholder="字数最少5个字"></textarea>
						</div>
					</div>
					<div class="ui-dialog-ft">
						<button type="button" data-role="button" class="close_groupMsg">关闭</button>
						<button type="button" data-role="button" id="queren">确认</button>
					</div>
				</div>
			</div>
		</section>
	</body>
</html>
