<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
        <meta name="format-detection" content="telephone=no">
        <link rel="stylesheet" href="../../css/frozen.css">
        <link rel="stylesheet" href="../../css/style.css" />
        <link rel="stylesheet" href="../../fontIcon/iconfont.css" />
        
        <script src="../../js/jquery-1.8.3.min.js"></script>
        <script>$.noConflict();</script>
        <script src="../../lib/zepto.min.js"></script>
        <script src="../../js/frozen.js"></script>
        <script src="../../js/Utils.js"></script>
        
		<title>确认预约信息</title>
		<style type="text/css">
			html,body{font-family: "微软雅黑";height: 100%;width: 100%;}
			.ck_doctor{display: block;width: 100%;height: 60px;background-color: #FFFFFF; line-height:60px;margin-top: 5px;}
			.ck_doctor_name{margin-left: 10px;}
			.ck_doctor_btn{display: block;float: right;width: 100px;border: 1px solid #00BA7F;height: 30px;line-height: 30px;border-radius: 2px;margin-top: 15px;margin-right: 10px;}
			.ck_doctor_btn>i, .ck_doctor_btn>span{display: block;float:left ;color: #0066CC;}
			.ck_doctor_btn>i{font-size: 24px;margin-top: -7px;color: #00BA7F;}
			.ck_doctor_btn>span{font-size: 14px;color: #00BA7F;}
			.comfirm_item{display: block;width: 100%;height: 50px;border-bottom: 1px solid #EEEAEB;background-color: #FFFFFF;line-height: 50px;}
			.item_name{display: block;float: left; margin-left: 10px;width: 28%;}
			.item_value{display: block;float: left;width: 65%;text-align: right;height: 50px;line-height: 50px;}
			.item_value>i{display: block;float: right;margin-top: 2px;margin-right: -10px;}
			.comfirm_item.menz{margin-top: 0;margin-top: 10px;margin-bottom: 10px;border-bottom:none}
			.login_btn{display: block;width: 90%;margin: 0 auto;margin-top: 25px;background-color: #FFFFFF;}
			.login_btn>button{background: #167F3B;font-size: 16px;}
			.ui-radio input:checked:after{background: #167F3B;}
			
			.img_item{margin-left: 10px;}
			.login_btn>span{display: block;width: 60%;margin: 0 auto;font-size: 14px;margin-top: 10px;}
			.ui-dialog-cnt{display: block; width: 90%;margin: 0 auto;border-radius:5px ;background-color: #FFFFFF;}
			.ui-dialog-bd{background-color: #F7F7F7;padding: 0 10px;min-height:200px;max-height: 450px;border-radius: 3px;-webkit-box-pack:inherit;}
			.add_per{display: block;width: 100%;height: 50px;line-height: 50px;background-color: #FFFFFF;margin-top: 15px;}
			.add_per>span{display: block;width: 45%;height: 100%;margin: 0 auto;}
			.add_per>span>i,.add_per>span>span{display: block;float:left ;color: #00BA7F;}
			.add_per>span>i{font-size: 30px;margin-top: 3px;color: #00BA7F;}
			.per_name{display: block;width: 90%;margin:0 auto;background-color: #FFFFFF;margin-top: 10px;height: 35px;line-height: 35px;}
			.per_name>span{display: block;float: left;width: 44%;margin-left: 10px;}
			.per_relationship{text-align: right;}
			.hidden{display: none;}
			.ui-dialog-cnt{margin:50% auto;}
		</style>
		</style>
		<script type="text/javascript">
			var outChargeNo = '';//商户充值业务流水
        	$(function(){
        		
        		$("#jzrxz").click(function(){
        			//查询的是单个就诊人信息， 后期需改为多个
        			$.post(Utils.getRoot()+"/registerApp/selPatient", {}, function(data){
        				$("#patientid_").val(data.patientid);//APP患者ID
        				$("#patCardNo_").val(data.patCardNo);//医院患者ID
	        			$("#patientname_").html(data.patientname);
	        			$(".addPatient").hide();
        			});
        			
        			$(".addPatient").show();
        		});
        		$("#add_rela").click(function(){
        			window.location.href="../yuyueguahao/addPerple.html"
        		});
        		$("#choosePeople_").click(function(){
        			$("#patientid").val($("#patientid_").val());
        			$("#patCardNo").val($("#patCardNo_").val());
        			$("#patientname").html($("#patientname_").html());
        			$(".addPatient").hide();
        		})
        		$(".close_dialog,.ui-dialog-close").click(function(){
					$(".ui-dialog").hide();
				});
        		var Request = Utils.getRequest();
        		
        		$("#deptName_").text(Request["deptName"]);
        		$("#doctorName_").text(Request["doctorName"]);
        		$("#clinicType_").text(Request["clinicType"])
        		$("#fullTime_").text(Request["dateTime"]+" "+Request["beginTime"]+"~"+Request["endTime"]);
        		$("#CNregFee_").text("￥"+""+Request["regFee"]+"元");
				$("input[name='deptCode_']").val(Request["deptCode"]);
				$("input[name='doctorCode_']").val(Request["doctorCode"]);
				$("input[name='scheduleDate_']").val(Request["dateTime"]);
				$("input[name='timeFlag_']").val(Request["timeFlag"]);
				$("input[name='beginTime_']").val(Request["beginTime"]);
				$("input[name='endTime_']").val(Request["endTime"]);
        		$("input[name='regFee_']").val(parseInt(Request["regFee"])*100);
        		
        		
        		$("#zf").click(function(){//支付成功后添加信息
        			if ($("#patientid").val()=="") {
        				$("#dialogText").html("请选择就诊人！");
						$(".ui-dialog").show();
					}else{
						var params={};
						params.divisionName=$("#deptName_").text();
						params.divisionId=$("input[name='deptCode_']").val();
						params.doctorName=$("#doctorName_").text();
						params.clinicType=$("#clinicType_").text();
						params.bespeakTime=$("#fullTime_").text();
						params.money=$("input[name='regFee_']").val();
						params.doctorId=$("input[name='doctorCode_']").val();
						params.patientId=$("#patientid").val();
						params.scheduleDate=$("input[name='scheduleDate_']").val();
						params.timeFlag=$("input[name='timeFlag_']").val();
						params.beginTime=$("input[name='beginTime_']").val();
						params.endTime=$("input[name='endTime_']").val();
						params.regFee=$("input[name='regFee_']").val();
						
						$(".ui-loading-block").show();
						$(".ui-loading-block").css("margin","45% 0 0 31%");
						
						var patCardNo = $("#patCardNo").val();
						
						if (patCardNo.length>3) {//挂号支付
							//医院锁号，生成商户订单号
							$.post(Utils.getRoot()+"/registerApp/addbespeakInfo", params, function(data){
								if (data.success) {
									outChargeNo = data.data[0].hisOrdNum;
				        			//统一支付下单，生产支付凭证
				        			$.post(Utils.getRoot()+"/registerApp/recharge", {
				        				outChargeNo: data.data[0].hisOrdNum,
										chargeAmt: data.data[0].regFee,
										channel: $("input[name='channel_radio']:checked").val()
				        			}, function(res){
				        				$(".ui-loading-block").hide();
										if (res.success) {
											window.location.href = res.data.directUrl;
										} else {
											$("#dialogText").html(res.message);
											$(".ui-dialog").show();
										}
									});
								}else{
									$(".ui-loading-block").hide();
									$("#dialogText").html(data.message);
									$(".ui-dialog").show();
								}
							});
						} else{//挂号不支付
							$.post(Utils.getRoot()+"/registerApp/addbespeakInfoNoId", params, function(res){
									if (res.success) {
										alert(res.message);
									}else{
										alert(res.message);
									}
								});
						}
						
						
					}
        		});
        	})
        	
        	//页面关闭时关闭交易订单
        	window.onunload = function(){
        		if(outChargeNo){
        			$.post(Utils.getRoot()+"/registerApp/rechargeClose", {
        				outChargeNo: outChargeNo
        			}, function(res){});
        		}
        	}
       </script>
	</head>
	<body ontouchstart>
		<header class="ui-header ui-header-positive">
			<i class="ui-icon ui-icon-return" onclick="history.back()"></i>
			<h4 style="margin-left: 25px;">
				<span>预约挂号确认</span>
				<span class="reflash_item"><i class="iconfont icon-switch"></i></span>
			</h4>
		</header>
		<section class="ui-container"> 
			<section id="list">
				<div class="ck_doctor">
					<span class="ck_doctor_name">就诊人:</span>
					<input type="hidden" id="patCardNo" value="" >
					<input type="hidden" id="patientid" value="" >
					<span id="patientname" ></span>
					<span class="ck_doctor_btn" id="jzrxz" ><i class="ui-icon ui-icon-add-people" ></i>
						<span>选择就诊人</span>
					</span>
				</div>
				<div class="comfirm_item ">
					<span class="item_name">科室名称</span>
					<input type="hidden" name="deptCode_" />
					<span class="item_value" id="deptName_"></span>
				</div>
				<div class="comfirm_item ">
					<span class="item_name">医生名字</span>
					<input type="hidden" name="doctorCode_" />
					<span class="item_value" id="doctorName_"></span>
				</div>
				<div class="comfirm_item ">
					<span class="item_name">出诊类型</span>
					<input type="hidden" name="doctorCode_" />
					<span class="item_value" id="clinicType_"></span>
				</div>
				<div class="comfirm_item ">
					<span class="item_name">就诊时间</span>
					<input type="hidden" name="scheduleDate_" />
					<input type="hidden" name="beginTime_" />
					<input type="hidden" name="endTime_" />
					<input type="hidden" name="timeFlag_" />
					<span class="item_value" id="fullTime_"></span>
				</div>
				<div class="comfirm_item ">
					<span class="item_name">挂号金额</span>
					<input type="hidden" name="regFee_" />
					<span class="item_value" id="CNregFee_"></span>
				</div>
				
				<div class="comfirm_item menz">
					<span class="item_name">支付方式</span>
				</div>
				<div>
					<div class="ui-form-item ui-form-itemd-radio ">
                        <label class="ui-radio" for="radio">
                            <input type="radio" checked="" name="channel_radio" value="WX_WAP" />
                        </label>
                        <span>微信</span>
                    </div>
                    <div class="ui-form-item ui-form-item-radio">
                        <label class="ui-radio" for="radio">
                            <input type="radio" name="channel_radio" value="ALI_WAP" />
                        </label>
                        <span>支付宝</span>
                    </div>
				</div>
				<div style="display: block;float: left;width: 100%;height: 130px; background-color: #FFFFFF;">
					<div class="login_btn">
						<button class="ui-btn ui-btn-lg ui-btn-primary" id="zf">确认预约</button>
					</div>
				</div>
			</section>
		</section>
		<section id="dialog">
			<div class="demo-item">
				<div class="demo-block">
					<div class="ui-dialog addPatient">
					    <div class="ui-dialog-cnt">
						    <header class="ui-dialog-hd ui-border-b">
			                    <h3>选择就诊人</h3>
			                    <i class="ui-dialog-close" data-role="button"></i>
			                </header>
			                 <div class="ui-dialog-bd">
					            <div class="add_per">
					            	<span id="add_rela">
						            	<i class="ui-icon ui-icon-add-people"></i>
						            	<span>添加就诊人</span>
					            	</span>
					            </div>
					            <div class="per_name" id="choosePeople_">
					            	<input type="hidden" id="patientid_" value="" >
					            	<input type="hidden" id="patCardNo_" value="" >
					            	<span id="patientname_">测试人员</span>
					            	<span class="per_relationship">本人</span>
					            </div>
					        </div>
					    </div>        
					</div>
					
				</div>
			</div>
		</section>
		
		<div class="ui-dialog">
		    <div class="ui-dialog-cnt">
		        <div class="ui-dialog-bd"> 
		            <i class="ui-dialog-close" data-role="button"></i>
		            <h4>温馨提示：</h4> 
		            <span id="dialogText"></span>
		        </div>
		        <div class="ui-dialog-ft">
		            <button type="button" data-role="button" class="close_dialog">关闭</button>
		        </div>
		    </div>        
		</div>
		
		<!--刷新-->
		<section id="actionsheet">
			<div class="demo-item">
				<div class="demo-block">
					<div class="ui-actionsheet ">  
						<div class="ui-actionsheet-cnt">
							<button class="reflash_btn">刷新</button>  
							<button class="actionsheetClose">取消</button> 
						</div>         
					</div>
				</div>
			</div>
		</section>
		
		<script type="text/javascript">
			$(function(){
				//刷新页面
				$(".reflash_item").on("click",function(){
					$(".ui-actionsheet").addClass("show");
				});
				$(".actionsheetClose").on("click",function(){
					$(".ui-actionsheet").removeClass("show");
				});
				$(".reflash_btn").on("click",function(){
					location.reload();
					$(".ui-actionsheet").removeClass("show");
				});
        		
			});
		</script>
	</body>
</html>
